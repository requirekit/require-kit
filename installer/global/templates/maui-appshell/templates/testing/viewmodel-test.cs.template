using CommunityToolkit.Mvvm.ComponentModel;
using ErrorOr;
using FluentAssertions;
using NSubstitute;
using Xunit;
using {{ProjectName}}.Presentation.{{FeatureName}};
using {{ProjectName}}.Infrastructure.Navigation;
using {{ProjectName}}.Services.Interfaces;

namespace {{ProjectName}}.Tests.Presentation.{{FeatureName}};

/// <summary>
/// Tests for {{ViewModelName}}.
/// Tests presentation logic, command execution, and error handling.
/// </summary>
public class {{ViewModelName}}Tests
{
    private readonly {{DomainOperation}} _operation;
    private readonly INavigator _navigator;
    private readonly ILogService _logService;
    private readonly {{ViewModelName}} _sut;

    public {{ViewModelName}}Tests()
    {
        _operation = Substitute.For<{{DomainOperation}}>();
        _navigator = Substitute.For<INavigator>();
        _logService = Substitute.For<ILogService>();
        _sut = new {{ViewModelName}}(_navigator, _operation, _logService);
    }

    #region Lifecycle Tests

    [Fact]
    public async Task OnViewAppearing_ExecutesLoadCommand()
    {
        // Arrange
        var expectedData = new List<{{ItemType}}>
        {
            new {{ItemType}} { {{PropertyInitializers}} }
        };
        _operation.ExecuteAsync(Arg.Any<{{OperationParameters}}>()).Returns(expectedData);

        // Act
        await _sut.OnViewAppearing();

        // Assert
        _sut.Items.Should().HaveCount(1);
        _sut.HasData.Should().BeTrue();
        _logService.Received(1).TrackEvent("{{ViewModelName}}ViewAppeared");
        _logService.Received(1).TrackEvent("{{ViewModelName}}DataLoaded", Arg.Any<Dictionary<string, object>>());
    }

    [Fact]
    public async Task OnViewDisappearing_TracksEvent()
    {
        // Act
        await _sut.OnViewDisappearing();

        // Assert
        _logService.Received(1).TrackEvent("{{ViewModelName}}ViewDisappeared");
    }

    #endregion

    #region LoadCommand Tests

    [Fact]
    public async Task LoadCommand_WhenOperationSucceeds_PopulatesItems()
    {
        // Arrange
        var expected = new List<{{ItemType}}>
        {
            new {{ItemType}} { {{PropertyInitializers}} }
        };
        _operation.ExecuteAsync(Arg.Any<{{OperationParameters}}>()).Returns(expected);

        // Act
        await _sut.LoadCommand.ExecuteAsync(null);

        // Assert
        _sut.Items.Should().HaveCount(1);
        _sut.Items.Should().BeEquivalentTo(expected);
        _sut.HasData.Should().BeTrue();
        _sut.ErrorMessage.Should().BeEmpty();
        _sut.IsBusy.Should().BeFalse();
    }

    [Fact]
    public async Task LoadCommand_WhenOperationFails_SetsErrorMessage()
    {
        // Arrange
        var error = Error.Unexpected("Test.Error", "Test error message");
        _operation.ExecuteAsync(Arg.Any<{{OperationParameters}}>()).Returns(error);

        // Act
        await _sut.LoadCommand.ExecuteAsync(null);

        // Assert
        _sut.Items.Should().BeEmpty();
        _sut.HasData.Should().BeFalse();
        _sut.ErrorMessage.Should().Be("Test error message");
        _sut.IsBusy.Should().BeFalse();
    }

    [Fact]
    public async Task LoadCommand_SetsIsBusyDuringExecution()
    {
        // Arrange
        var tcs = new TaskCompletionSource<ErrorOr<List<{{ItemType}}>>>();
        _operation.ExecuteAsync(Arg.Any<{{OperationParameters}}>()).Returns(tcs.Task);

        // Act
        var task = _sut.LoadCommand.ExecuteAsync(null);

        // Assert - IsBusy should be true during execution
        _sut.IsBusy.Should().BeTrue();
        _sut.BusyMessage.Should().Be("Loading...");

        // Complete the operation
        tcs.SetResult(new List<{{ItemType}}>());
        await task;

        // Assert - IsBusy should be false after completion
        _sut.IsBusy.Should().BeFalse();
        _sut.BusyMessage.Should().BeEmpty();
    }

    [Fact]
    public async Task LoadCommand_WhenExceptionOccurs_HandlesGracefully()
    {
        // Arrange
        _operation.ExecuteAsync(Arg.Any<{{OperationParameters}}>()).Throws(new Exception("Unexpected error"));

        // Act
        await _sut.LoadCommand.ExecuteAsync(null);

        // Assert
        _sut.ErrorMessage.Should().Be("An unexpected error occurred");
        _sut.HasData.Should().BeFalse();
        _sut.IsBusy.Should().BeFalse();
        _logService.Received(1).TrackError(
            Arg.Any<Exception>(),
            Arg.Is<Dictionary<string, object>>(d =>
                d["Operation"].ToString() == "Load" &&
                d["ViewModel"].ToString() == "{{ViewModelName}}"));
    }

    #endregion

    #region ItemTappedCommand Tests

    [Fact]
    public async Task ItemTappedCommand_WhenItemValid_NavigatesToDetail()
    {
        // Arrange
        var item = new {{ItemType}} { {{PropertyInitializers}} };
        _navigator.Navigate<{{DetailViewModel}}, {{ItemType}}>(item).Returns(ErrorOr<{{ItemType}}>.From(item));

        // Act
        await _sut.ItemTappedCommand.ExecuteAsync(item);

        // Assert
        await _navigator.Received(1).Navigate<{{DetailViewModel}}, {{ItemType}}>(item);
        _sut.ErrorMessage.Should().BeEmpty();
        _logService.Received(1).TrackEvent("{{ViewModelName}}ItemTapped", Arg.Any<Dictionary<string, object>>());
    }

    [Fact]
    public async Task ItemTappedCommand_WhenItemNull_ReturnsEarly()
    {
        // Act
        await _sut.ItemTappedCommand.ExecuteAsync(null);

        // Assert
        await _navigator.DidNotReceive().Navigate<{{DetailViewModel}}, {{ItemType}}>(Arg.Any<{{ItemType}}>());
    }

    [Fact]
    public async Task ItemTappedCommand_WhenNavigationFails_SetsErrorMessage()
    {
        // Arrange
        var item = new {{ItemType}} { {{PropertyInitializers}} };
        var error = Error.Unexpected("Navigation.Failed", "Navigation error");
        _navigator.Navigate<{{DetailViewModel}}, {{ItemType}}>(item).Returns(error);

        // Act
        await _sut.ItemTappedCommand.ExecuteAsync(item);

        // Assert
        _sut.ErrorMessage.Should().Be("Navigation error");
        _logService.Received(1).TrackEvent("{{ViewModelName}}NavigationFailed", Arg.Any<Dictionary<string, object>>());
    }

    [Fact]
    public async Task ItemTappedCommand_WhenExceptionOccurs_HandlesGracefully()
    {
        // Arrange
        var item = new {{ItemType}} { {{PropertyInitializers}} };
        _navigator.Navigate<{{DetailViewModel}}, {{ItemType}}>(item).Throws(new Exception("Navigation exception"));

        // Act
        await _sut.ItemTappedCommand.ExecuteAsync(item);

        // Assert
        _sut.ErrorMessage.Should().Be("Navigation failed");
        _logService.Received(1).TrackError(Arg.Any<Exception>(), Arg.Any<Dictionary<string, object>>());
    }

    #endregion

    #region RefreshCommand Tests

    [Fact]
    public async Task RefreshCommand_ExecutesLoadCommand()
    {
        // Arrange
        var expected = new List<{{ItemType}}>
        {
            new {{ItemType}} { {{PropertyInitializers}} }
        };
        _operation.ExecuteAsync(Arg.Any<{{OperationParameters}}>()).Returns(expected);

        // Act
        await _sut.RefreshCommand.ExecuteAsync(null);

        // Assert
        _sut.Items.Should().HaveCount(1);
        _sut.HasData.Should().BeTrue();
    }

    #endregion

    #region Property Change Notification Tests

    [Fact]
    public void ErrorMessage_WhenSet_RaisesPropertyChanged()
    {
        // Arrange
        var propertyChangedRaised = false;
        _sut.PropertyChanged += (s, e) =>
        {
            if (e.PropertyName == nameof(_sut.ErrorMessage))
                propertyChangedRaised = true;
        };

        // Act
        _sut.ErrorMessage = "Test error";

        // Assert
        propertyChangedRaised.Should().BeTrue();
    }

    [Fact]
    public void IsBusy_WhenSet_RaisesPropertyChanged()
    {
        // Arrange
        var propertyChangedRaised = false;
        _sut.PropertyChanged += (s, e) =>
        {
            if (e.PropertyName == nameof(_sut.IsBusy))
                propertyChangedRaised = true;
        };

        // Act
        _sut.IsBusy = true;

        // Assert
        propertyChangedRaised.Should().BeTrue();
    }

    [Fact]
    public void HasData_WhenSet_RaisesPropertyChanged()
    {
        // Arrange
        var propertyChangedRaised = false;
        _sut.PropertyChanged += (s, e) =>
        {
            if (e.PropertyName == nameof(_sut.HasData))
                propertyChangedRaised = true;
        };

        // Act
        _sut.HasData = true;

        // Assert
        propertyChangedRaised.Should().BeTrue();
    }

    [Fact]
    public void BusyMessage_WhenSet_RaisesPropertyChanged()
    {
        // Arrange
        var propertyChangedRaised = false;
        _sut.PropertyChanged += (s, e) =>
        {
            if (e.PropertyName == nameof(_sut.BusyMessage))
                propertyChangedRaised = true;
        };

        // Act
        _sut.BusyMessage = "Loading...";

        // Assert
        propertyChangedRaised.Should().BeTrue();
    }

    #endregion

    #region Command CanExecute Tests

    [Fact]
    public void LoadCommand_CanExecute_ReturnsTrue()
    {
        // Arrange & Act
        var canExecute = _sut.LoadCommand.CanExecute(null);

        // Assert
        canExecute.Should().BeTrue();
    }

    [Fact]
    public void RefreshCommand_CanExecute_ReturnsTrue()
    {
        // Arrange & Act
        var canExecute = _sut.RefreshCommand.CanExecute(null);

        // Assert
        canExecute.Should().BeTrue();
    }

    #endregion

    #region Error Handling Tests

    [Fact]
    public async Task LoadCommand_WithMultipleErrors_DisplaysFirstError()
    {
        // Arrange
        var errors = new List<Error>
        {
            Error.Validation("Error.1", "First error"),
            Error.Validation("Error.2", "Second error")
        };
        _operation.ExecuteAsync(Arg.Any<{{OperationParameters}}>()).Returns(errors);

        // Act
        await _sut.LoadCommand.ExecuteAsync(null);

        // Assert
        _sut.ErrorMessage.Should().Be("First error");
    }

    [Fact]
    public async Task LoadCommand_ClearsErrorMessage_OnSuccess()
    {
        // Arrange
        _sut.ErrorMessage = "Previous error";
        var expected = new List<{{ItemType}}> { new {{ItemType}} { {{PropertyInitializers}} } };
        _operation.ExecuteAsync(Arg.Any<{{OperationParameters}}>()).Returns(expected);

        // Act
        await _sut.LoadCommand.ExecuteAsync(null);

        // Assert
        _sut.ErrorMessage.Should().BeEmpty();
    }

    #endregion

    #region Integration Tests

    [Fact]
    public async Task FullWorkflow_LoadData_SelectItem_NavigateToDetail()
    {
        // Arrange
        var items = new List<{{ItemType}}>
        {
            new {{ItemType}} { {{PropertyInitializers}} }
        };
        _operation.ExecuteAsync(Arg.Any<{{OperationParameters}}>()).Returns(items);
        _navigator.Navigate<{{DetailViewModel}}, {{ItemType}}>(Arg.Any<{{ItemType}}>())
            .Returns(ErrorOr<{{ItemType}}>.From(items[0]));

        // Act - Load data
        await _sut.LoadCommand.ExecuteAsync(null);

        // Assert - Data loaded
        _sut.Items.Should().HaveCount(1);
        _sut.HasData.Should().BeTrue();

        // Act - Select item
        await _sut.ItemTappedCommand.ExecuteAsync(items[0]);

        // Assert - Navigation occurred
        await _navigator.Received(1).Navigate<{{DetailViewModel}}, {{ItemType}}>(items[0]);
        _sut.ErrorMessage.Should().BeEmpty();
    }

    #endregion
}
