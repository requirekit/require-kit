using ErrorOr;
using FluentAssertions;
using System.Net;
using System.Net.Http.Json;
using Xunit;

namespace {{ProjectName}}.Tests.Services;

/// <summary>
/// Tests for {{ServiceName}}.
/// Uses HttpClient mocking for isolated testing.
/// </summary>
public class {{ServiceName}}Tests
{
    private readonly HttpClient _httpClient;
    private readonly MockHttpMessageHandler _mockHandler;
    private readonly {{ServiceName}} _sut;

    public {{ServiceName}}Tests()
    {
        _mockHandler = new MockHttpMessageHandler();
        _httpClient = new HttpClient(_mockHandler)
        {
            BaseAddress = new Uri("https://api.test.com")
        };
        _sut = new {{ServiceName}}(_httpClient);
    }

    [Fact]
    public async Task {{MethodName}}Async_WhenApiSucceeds_ReturnsSuccess()
    {
        // Arrange
        var expected = new {{ReturnType}} { {{PropertyInitializers}} };
        _mockHandler.SetupResponse(HttpStatusCode.OK, expected);

        // Act
        var result = await _sut.{{MethodName}}Async({{Parameters}});

        // Assert
        result.IsError.Should().BeFalse();
        result.Value.Should().BeEquivalentTo(expected);
    }

    [Fact]
    public async Task {{MethodName}}Async_WhenApiReturnsNotFound_ReturnsNotFoundError()
    {
        // Arrange
        _mockHandler.SetupResponse(HttpStatusCode.NotFound, ({{ReturnType}}?)null);

        // Act
        var result = await _sut.{{MethodName}}Async({{Parameters}});

        // Assert
        result.IsError.Should().BeTrue();
        result.FirstError.Type.Should().Be(ErrorType.Unexpected);
        result.FirstError.Code.Should().Contain("Failed");
    }

    [Fact]
    public async Task {{MethodName}}Async_WhenApiReturnsServerError_ReturnsUnexpectedError()
    {
        // Arrange
        _mockHandler.SetupResponse(HttpStatusCode.InternalServerError, ({{ReturnType}}?)null);

        // Act
        var result = await _sut.{{MethodName}}Async({{Parameters}});

        // Assert
        result.IsError.Should().BeTrue();
        result.FirstError.Type.Should().Be(ErrorType.Unexpected);
    }

    [Fact]
    public async Task {{MethodName}}Async_WhenNetworkFails_ReturnsUnexpectedError()
    {
        // Arrange
        _mockHandler.SetupException(new HttpRequestException("Network error"));

        // Act
        var result = await _sut.{{MethodName}}Async({{Parameters}});

        // Assert
        result.IsError.Should().BeTrue();
        result.FirstError.Type.Should().Be(ErrorType.Unexpected);
        result.FirstError.Description.Should().Contain("Network error");
    }

    [Fact]
    public async Task {{MethodName}}Async_WhenResponseIsNull_ReturnsNotFoundError()
    {
        // Arrange
        _mockHandler.SetupResponse(HttpStatusCode.OK, ({{ReturnType}}?)null);

        // Act
        var result = await _sut.{{MethodName}}Async({{Parameters}});

        // Assert
        result.IsError.Should().BeTrue();
        result.FirstError.Code.Should().Contain("NoData");
    }
}

/// <summary>
/// Mock HttpMessageHandler for testing HTTP requests.
/// </summary>
public class MockHttpMessageHandler : HttpMessageHandler
{
    private HttpStatusCode _statusCode = HttpStatusCode.OK;
    private object? _content;
    private Exception? _exception;

    public void SetupResponse<T>(HttpStatusCode statusCode, T? content)
    {
        _statusCode = statusCode;
        _content = content;
        _exception = null;
    }

    public void SetupException(Exception exception)
    {
        _exception = exception;
    }

    protected override Task<HttpResponseMessage> SendAsync(
        HttpRequestMessage request,
        CancellationToken cancellationToken)
    {
        if (_exception is not null)
        {
            throw _exception;
        }

        var response = new HttpResponseMessage(_statusCode);

        if (_content is not null)
        {
            response.Content = JsonContent.Create(_content);
        }

        return Task.FromResult(response);
    }
}
