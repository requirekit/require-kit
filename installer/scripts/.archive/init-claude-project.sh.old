#!/bin/bash

# Agentic Flow Project Initialization Script V2
# Smart initialization that adapts to existing project structures

set -e

# Configuration
CLAUDE_HOME="${CLAUDE_HOME:-$HOME/.claude}"
PROJECT_DIR="$(pwd)"
TEMPLATE="${1:-default}"

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

print_header() {
    echo ""
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘         Agentic Flow Initialization                    â•‘${NC}"
    echo -e "${BLUE}â•‘         Template: ${BOLD}$TEMPLATE                           ${NC}${BLUE}â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# Detect existing project type
detect_project_type() {
    if [ -f "*.csproj" ] || [ -f "*/*.csproj" ] || [ -f "*.sln" ]; then
        if grep -q "Microsoft.Maui" *.csproj 2>/dev/null || grep -q "Microsoft.Maui" */*.csproj 2>/dev/null; then
            echo "maui"
        elif grep -q "Microsoft.AspNetCore" *.csproj 2>/dev/null || grep -q "Microsoft.AspNetCore" */*.csproj 2>/dev/null; then
            echo "dotnet-microservice"
        else
            echo "dotnet"
        fi
    elif [ -f "package.json" ]; then
        if grep -q "react" package.json; then
            echo "react"
        elif grep -q "vue" package.json; then
            echo "vue"
        else
            echo "node"
        fi
    elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
        echo "python"
    else
        echo "unknown"
    fi
}

print_success() {
    echo -e "${GREEN}âœ“ $1${NC}"
}

print_error() {
    echo -e "${RED}âœ— $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš  $1${NC}"
}

print_info() {
    echo -e "${BLUE}â„¹ $1${NC}"
}

# Check if global installation exists
check_global_installation() {
    if [ ! -d "$CLAUDE_HOME" ]; then
        print_error "Agentic Flow global installation not found at $CLAUDE_HOME"
        echo ""
        echo "Please install Agentic Flow globally first:"
        echo "  cd /path/to/ai-engineer/installer"
        echo "  ./install.sh"
        exit 1
    fi
    print_success "Found Agentic Flow installation at $CLAUDE_HOME"
}

# Check if already initialized
check_existing() {
    if [ -d ".claude" ]; then
        print_warning ".claude directory already exists"
        read -p "Reinitialize? This will backup the existing configuration (y/n): " -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_info "Initialization cancelled"
            exit 0
        fi
        # Backup existing
        mv .claude .claude.backup.$(date +%Y%m%d_%H%M%S)
        print_success "Existing configuration backed up"
    fi
}

# Smart structure creation based on project type
create_smart_structure() {
    local detected_type=$(detect_project_type)
    print_info "Detected project type: $detected_type"
    
    # Always create .claude at root
    mkdir -p .claude/{agents,commands,hooks,templates}
    
    # Always create docs at root
    mkdir -p docs/{requirements,bdd/features,adr,state}
    mkdir -p docs/requirements/{draft,approved,implemented}
    
    # Handle test directory based on project type
    case "$detected_type" in
        maui|dotnet*)
            # .NET projects typically have test projects in solution
            print_info "Tests will be managed within .NET solution structure"
            ;;
        *)
            # Other projects benefit from separate test directories
            if [ ! -d "tests" ]; then
                mkdir -p tests/{unit,integration,e2e}
                print_success "Created test directories"
            else
                print_info "Using existing tests directory"
            fi
            ;;
    esac
    
    # Don't create src if project already has structure
    if [ "$detected_type" = "unknown" ] && [ ! -d "src" ]; then
        mkdir -p src
        print_info "Created src directory for new project"
    elif [ -d "src" ]; then
        print_info "Using existing src directory"
    else
        print_info "Project has existing structure, skipping src creation"
    fi
    
    print_success "Smart project structure created"
}

# Copy template files based on detected or specified template
copy_smart_template() {
    local detected_type=$(detect_project_type)
    local effective_template="$TEMPLATE"
    
    # Override template if we detected a specific type
    if [ "$TEMPLATE" = "default" ] && [ "$detected_type" != "unknown" ]; then
        case "$detected_type" in
            maui) effective_template="maui" ;;
            dotnet-microservice) effective_template="dotnet-microservice" ;;
            dotnet*) effective_template="dotnet-microservice" ;;
            react|vue) effective_template="react" ;;
            python) effective_template="python" ;;
            *) effective_template="default" ;;
        esac
        print_info "Auto-selected template: $effective_template"
    fi
    
    local template_dir="$CLAUDE_HOME/templates/$effective_template"
    
    if [ ! -d "$template_dir" ]; then
        print_warning "Template '$effective_template' not found, using default"
        template_dir="$CLAUDE_HOME/templates/default"
        effective_template="default"
    fi
    
    # Copy CLAUDE.md context file
    if [ -f "$template_dir/CLAUDE.md" ]; then
        cp "$template_dir/CLAUDE.md" .claude/
        print_success "Copied project context file for $effective_template"
    fi
    
    # Copy agents
    if [ -d "$template_dir/agents" ]; then
        cp -r "$template_dir/agents/"* .claude/agents/ 2>/dev/null || true
        print_success "Copied AI agents"
    fi
    
    # Copy templates
    if [ -d "$template_dir/templates" ]; then
        cp -r "$template_dir/templates/"* .claude/templates/ 2>/dev/null || true
        print_success "Copied template files"
    fi
    
    # Link to global commands
    if [ -d "$CLAUDE_HOME/commands" ]; then
        for cmd in "$CLAUDE_HOME/commands"/*.md; do
            if [ -f "$cmd" ]; then
                local cmd_name=$(basename "$cmd")
                ln -sf "$cmd" ".claude/commands/$cmd_name" 2>/dev/null || \
                cp "$cmd" ".claude/commands/$cmd_name"
            fi
        done
        print_success "Linked Agentic Flow commands"
    fi
    
    TEMPLATE="$effective_template"  # Update global for later use
}

# Create project configuration
create_config() {
    print_info "Creating project configuration..."
    
    local project_name=$(basename "$PROJECT_DIR")
    
    cat > .claude/settings.json << EOF
{
  "version": "1.0.0",
  "extends": "$CLAUDE_HOME/templates/$TEMPLATE",
  "project": {
    "name": "$project_name",
    "template": "$TEMPLATE",
    "created": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
  },
  "methodology": {
    "requirements": "EARS",
    "testing": "BDD",
    "documentation": "ADR"
  },
  "quality": {
    "coverage": 80,
    "complexity": 10,
    "gates": true
  }
}
EOF
    
    print_success "Created project configuration"
}

# Create initial files
create_initial_files() {
    print_info "Creating initial documentation..."
    
    # Create .claudeignore
    cat > .claude/.claudeignore << 'EOF'
# Files to exclude from Claude context
node_modules/
venv/
.venv/
__pycache__/
*.pyc
dist/
build/
.git/
.env
*.log
coverage/
*.tmp
EOF
    
    # Create initial sprint file
    cat > docs/state/current-sprint.md << EOF
---
sprint: 1
start: $(date +%Y-%m-%d)
status: planning
---

# Sprint 1 - Project Setup

## Goals
- [ ] Set up Claude/Agentic Flow
- [ ] Define initial requirements
- [ ] Create first BDD scenarios

## Progress
- Overall: 10% [â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘]

## Next Steps
1. Use \`/gather-requirements\` to start requirements gathering
2. Use \`/formalize-ears\` to convert to EARS notation
3. Use \`/generate-bdd\` to create test scenarios
EOF
    
    # Create first ADR
    cat > docs/adr/0001-adopt-agentic-flow.md << EOF
---
id: ADR-001
status: accepted
date: $(date +%Y-%m-%d)
---

# ADR-001: Adopt Claude/Agentic Flow System

## Status
Accepted

## Context
We need a systematic approach to software development with clear requirements, automated testing, and quality gates.

## Decision
Adopt the Claude/Agentic Flow system with EARS requirements and BDD testing.

## Consequences
**Positive:**
- Clear requirements traceability
- Automated test generation
- Quality enforcement

**Negative:**
- Initial learning curve
- Additional setup overhead
EOF
    
    print_success "Created initial documentation"
}

# Setup git hooks (if git repo)
setup_git_hooks() {
    if [ -d ".git" ]; then
        print_info "Setting up Git hooks..."
        
        # Create pre-commit hook
        cat > .git/hooks/pre-commit << 'EOF'
#!/bin/bash
# Claude/Agentic Flow pre-commit hook

echo "Running pre-commit checks..."

# Check for draft requirements
if ls docs/requirements/draft/*.md 2>/dev/null | grep -q .; then
    echo "âš ï¸  Draft requirements found. Consider formalizing with /formalize-ears"
fi

# Run tests if available
if [ -f "package.json" ] && grep -q '"test"' package.json; then
    npm test -- --run --silent || exit 1
elif [ -f "pytest.ini" ] || [ -f "pyproject.toml" ]; then
    python -m pytest tests/unit -q || exit 1
fi

echo "âœ… Pre-commit checks passed"
EOF
        
        chmod +x .git/hooks/pre-commit
        print_success "Git hooks configured"
    fi
}

# Create stack-specific files
create_stack_files() {
    case "$TEMPLATE" in
        react)
            print_info "Adding React-specific configuration..."
            cat > .claude/stacks/react.json << 'EOF'
{
  "name": "react",
  "testing": "vitest + playwright",
  "build": "vite",
  "language": "typescript"
}
EOF
            ;;
            
        python)
            print_info "Adding Python-specific configuration..."
            cat > .claude/stacks/python.json << 'EOF'
{
  "name": "python",
  "testing": "pytest",
  "framework": "fastapi",
  "language": "python3"
}
EOF
            ;;
            
        maui)
            print_info "Adding .NET MAUI-specific configuration..."
            cat > .claude/stacks/maui.json << 'EOF'
{
  "name": "maui",
  "testing": "xunit",
  "framework": "dotnet-maui",
  "language": "csharp",
  "target": "net8.0"
}
EOF
            ;;
            
        dotnet-microservice)
            print_info "Adding .NET Microservice-specific configuration..."
            cat > .claude/stacks/dotnet-microservice.json << 'EOF'
{
  "name": "dotnet-microservice",
  "testing": "xunit",
  "framework": "fastendpoints",
  "language": "csharp",
  "target": "net8.0"
}
EOF
            ;;
            
        fullstack)
            print_info "Adding Full Stack configuration..."
            cat > .claude/stacks/fullstack.json << 'EOF'
{
  "name": "fullstack",
  "frontend": "react",
  "backend": "python",
  "testing": "pytest + playwright"
}
EOF
            ;;
    esac
}

# Print next steps
print_next_steps() {
    echo ""
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}âœ… Claude project successfully initialized!${NC}"
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${BOLD}Project Structure Created:${NC}"
    echo "  .claude/       - Project configuration"
    echo "  docs/          - Requirements, BDD, ADRs"
    echo "  tests/         - Test suites"
    echo ""
    echo -e "${BOLD}Next Steps:${NC}"
    echo ""
    echo "1. Open in your IDE with Claude:"
    echo -e "   ${BLUE}code .${NC}  or  ${BLUE}cursor .${NC}"
    echo ""
    echo "2. Start gathering requirements:"
    echo -e "   ${BLUE}/gather-requirements${NC}"
    echo ""
    echo "3. Follow the workflow:"
    echo "   â€¢ Gather â†’ Formalize â†’ Generate â†’ Implement â†’ Test"
    echo ""
    echo -e "${BOLD}Available Commands in Claude:${NC}"
    echo "  /gather-requirements - Start requirements session"
    echo "  /formalize-ears     - Convert to EARS notation"
    echo "  /generate-bdd       - Create test scenarios"
    echo "  /execute-tests      - Run test suite"
    echo "  /update-state       - Update progress"
    echo ""
    echo -e "${BLUE}ðŸ“š Documentation:${NC} $CLAUDE_HOME/instructions/"
    echo -e "${BLUE}ðŸ“‹ Templates:${NC} .claude/templates/"
    echo -e "${BLUE}âš™ï¸  Configuration:${NC} .claude/settings.json"
}

# Main function
main() {
    print_header
    check_global_installation
    check_existing
    create_smart_structure
    copy_smart_template
    create_config
    create_initial_files
    setup_git_hooks
    create_stack_files
    print_next_steps
}

# Run main
main "$@"
