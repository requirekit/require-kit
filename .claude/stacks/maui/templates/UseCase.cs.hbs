using LanguageExt;
using static LanguageExt.Prelude;
using {{AppName}}.Core.Models;
using {{AppName}}.Services.Interfaces;
using {{AppName}}.UseCases.Interfaces;

namespace {{AppName}}.UseCases.Implementations;

public interface I{{UseCase}}UseCase : IUseCase<{{ErrorType}}, {{ReturnType}}>
{
}

public class {{UseCase}}UseCase : I{{UseCase}}UseCase
{
    private readonly IApiService _apiService;
    private readonly ICacheService _cacheService;
    private readonly ILogger<{{UseCase}}UseCase> _logger;
    
    public {{UseCase}}UseCase(
        IApiService apiService, 
        ICacheService cacheService,
        ILogger<{{UseCase}}UseCase> logger)
    {
        _apiService = apiService;
        _cacheService = cacheService;
        _logger = logger;
    }
    
    public async Task<Either<{{ErrorType}}, {{ReturnType}}>> ExecuteAsync(object? param = null)
    {
        return await TryAsync(async () =>
        {
            {{#if RequiresParam}}
            if (param == null)
            {
                return Left<{{ErrorType}}, {{ReturnType}}>(
                    new {{ErrorType}}("Parameter required", ErrorType.ValidationError));
            }
            {{/if}}
            
            var cacheKey = GenerateCacheKey(param);
            
            // Try cache first (if applicable)
            {{#if UseCache}}
            var cached = await _cacheService.GetAsync<{{ReturnType}}>(cacheKey);
            if (cached != null && !IsExpired(cached))
            {
                _logger.LogDebug("Returning cached result for key: {CacheKey}", cacheKey);
                return Right<{{ErrorType}}, {{ReturnType}}>(cached);
            }
            {{/if}}
            
            // Fetch from API
            var endpoint = BuildEndpoint(param);
            var response = await _apiService.GetAsync<{{ReturnType}}>(endpoint);
            
            return await response.MatchAsync(
                RightAsync: async data =>
                {
                    // Validate business rules
                    var validationResult = ValidateBusinessRules(data);
                    if (validationResult.IsFailed)
                    {
                        return Left<{{ErrorType}}, {{ReturnType}}>(
                            new {{ErrorType}}(validationResult.Error, ErrorType.BusinessRuleViolation));
                    }
                    
                    // Transform data if needed
                    var transformed = TransformData(data);
                    
                    {{#if UseCache}}
                    // Cache the result
                    await _cacheService.SetAsync(cacheKey, transformed, GetCacheExpiry());
                    {{/if}}
                    
                    return Right<{{ErrorType}}, {{ReturnType}}>(transformed);
                },
                LeftAsync: error => Task.FromResult(Left<{{ErrorType}}, {{ReturnType}}>(
                    new {{ErrorType}}(error.Message, ErrorType.ApiError)))
            );
        })
        .IfFail(ex =>
        {
            _logger.LogError(ex, "Failed to execute {{UseCase}}");
            return Left<{{ErrorType}}, {{ReturnType}}>(
                new {{ErrorType}}($"Failed to {{Description}}: {ex.Message}", ErrorType.UnknownError));
        });
    }
    
    private string GenerateCacheKey(object? param)
    {
        if (param == null) return "{{UseCase}}:all";
        
        return param switch
        {
            string id => $"{{UseCase}}:{id}",
            {{ParamType}} p => $"{{UseCase}}:{p.Id}",
            _ => $"{{UseCase}}:{param.GetHashCode()}"
        };
    }
    
    private string BuildEndpoint(object? param)
    {
        if (param == null) return "/api/v1/{{endpoint}}";
        
        return param switch
        {
            string id => $"/api/v1/{{endpoint}}/{id}",
            {{ParamType}} p => $"/api/v1/{{endpoint}}/{p.Id}",
            _ => "/api/v1/{{endpoint}}"
        };
    }
    
    private ValidationResult ValidateBusinessRules({{ReturnType}} data)
    {
        // Implement business rule validation
        {{#each BusinessRules}}
        if ({{condition}})
        {
            return ValidationResult.Fail("{{message}}");
        }
        {{/each}}
        
        return ValidationResult.Success();
    }
    
    private {{ReturnType}} TransformData({{ReturnType}} data)
    {
        // Implement any necessary data transformation
        return data;
    }
    
    private TimeSpan GetCacheExpiry()
    {
        return TimeSpan.FromMinutes({{CacheMinutes}});
    }
    
    private bool IsExpired(object cached)
    {
        // Implement cache expiry logic if needed
        return false;
    }
}

internal class ValidationResult
{
    public bool IsFailed { get; private set; }
    public string Error { get; private set; } = string.Empty;
    
    public static ValidationResult Success() => new() { IsFailed = false };
    public static ValidationResult Fail(string error) => new() { IsFailed = true, Error = error };
}
